# 前座

## 身の回りにあるネットワーク（インターネット）

- パソコン（有線、Wi-Fi）
- スマホ（Wi-Fi、モバイルネットワーク）
- ゲーム機（Wi-Fi）
- 家電（Wi-Fi、モバイルネットワーク）
- 時計（Bluetooth）
- 自動車、重機（モバイルネットワーク）

## 製品にあるネットワーク

- LabSolutions
- LabTotal
- LC, LCMS, (GC)

ネットワークは現代社会において、無くて成らない存在

## ネットワークはどのように成り立っているか

- 前述のようにデバイスは様々な通信方法（経路）でつながっている
- 方法ごとに違う決まりで通信していては大変
- ネットワーク通信が円滑に行われるよう、
  - 通信過程を階層として考える概念が標準化されている
  - 階層ごとに様々な **プロトコル** が定義されている
  - ソフトウェア、ミドルウェア、ハードウェアは自分が該当する層に適するプロトコルを実装する
  - 各層は上位/下位の違いを意識しないで済む

<img src="1.17.png" style="width: 400px;">
無線機ではなくて携帯電話のほうがよい（無線は一方向通信なので）
[図1.17]

# ネットワークのプロトコル

- どんな層に役割を分けたらよいか
- どんなプロトコルで通信したらよいか

役割分担のモデルとして **OSI参照モデル** が提唱された

## OSI参照モデル

- Open Systems Interconnection
- ソフトウェア/OS/端末/通信経路など、階層化された **役割** のモデル
- 国際標準化機構（ISO）によって標準化された
- 世の中の通信機器やプロトコルはこのモデルに基づいて設計・実装されている
- あくまでモデルであり、これに100%忠実に従う必要はない

<img src="1.19.png" style="width: 400px;">

[図1.19]

## 各層のプロトコルのいろいろな実装

<img src="2.8.png" style="width: 400px;">
[図2.8]

## 右側の分類は一体何？

- **TCP/IPモデル**  
  とは

    - 現代で **現実的に広く普及している** ネットワーク階層のモデル  
      またはそのモデルを構成するプロトコル群を指す

    - 「DARPAモデル」「インターネット・プロトコル・スイート」などとも呼ばれる  

- TCP/IPモデルは、OSI参照モデルと同様にISOで標準化されている

- 下図ではOSIと対で表現されているが，この表現をIETFは否定している[要出典]

  IETF: Internet Engineering Task Force

<img src="2.8.png" style="width: 400px;">
[図2.8]

## なぜTCP/IPが使われるようになった？

- TCP/IPはプロトコル群が基本的にオープンだった  
  他の実装はベンダー固有だったり、ライセンスが必要だったりした
  （プロプライエタリ・ソフトウェアと呼ばれる）
- TCP/IPモデルはOSI参照モデルよりも、より実用に即したモデルだった

上記の要因から、他のプロトコルよりも爆発的に普及して今日に至る

## TCP/IPの各層の役割

- アプリケーション層

  ソフトウェアで具体的なサービスを提供する

- トランスポート層

  アプリケーションから渡されるデータを届け先のアプリケーションと協調してやり取りする

- ネットワーク層

  トランスポート層から渡されたデータをネットワークを介して宛先に届ける
  **End-to-End通信** を実現する

# 閑話休題



## TCP/IPでのデータの扱い

- 決まった長さに断片化された単位でデータを扱う
  - トランスポート層では「セグメント」という
  - ネットワーク層では「パケット」という
- データは各層で断片化され、専用のヘッダーが付加されてゆく

<img src="2.17-0.png" style="width: 800px;">
[図2.17]

## TCP/IPでのデータの流れ

<img src="2.18.png" style="width: 400px;">
[図2.18]

# TCP/IP のモデルにおける各層の役割

## アプリケーション層 (2.4.6)

- アプリケーション同士がやり取りする層  

    - 具体的なサービス，データの表現方法，プログラムの通信開始から終了までの手順などを提供する。

    - 特定のアプリ同士、独自のプロトコルを使うことも多い  

      LabSolutions はこのアプリケーション層を作りこんでいる

- TCP/IPで標準化されている共通プロトコルもたくさんある

    - FTP（ファイル転送）, HTTP（Web）, IMAP（Eメール）

<img src="2.11.png" style="width: 400px;">
[図2.11]

# トランスポート層 (TCP)

## トランスポート層 の役割

**アプリケーションから渡されるデータを届け先のアプリケーションと協調してやり取りする**

- 送信元・送信先のプロセスを指定するための仕組み
- 送信元・送信先が協調してデータを送受信するための仕組み
- 送信されたデータが正しいかを検証する仕組み
- 送信できなかった時にやり直す仕組み

このおかげでアプリケーションは上記のことを考える必要がない（ただしそうでないこともある）

## TCP

## UDP

# ネットワーク層 (IP)

## IPの役割

 **End-to-End通信を実現する**

- IPアドレスを提供する

- パケットを配達（ルーティング）する

  ネットワークの図をバンと出して，その中を最適な経路で通る仕組みを提供している

  郵便配達の仕組みと概念は同じ

このおかげで，トランスポート層はどんな経路を通るかを考える必要がない

## IPアドレスとは

- ノード（ホスト）を識別するための値
- IPv4は32bit、IPv6は128bitの2進数で表される

| 172.      | 31.       | 1.        | 3         |
| --------- | --------- | --------- | --------- |
| 1010 1100 | 0001 1111 | 0000 0001 | 0000 0011 |

## IPアドレスの構成

- 一つのIPアドレスで「ネットワーク」と「ホスト」の二つの場所を表す
  「ネットワーク部」と「ホスト部」で構成される
- どんなホストもサブネットに属する

<img src="4.11.png" style="width: 400px;">
[図4.11]

## IPアドレスのサブネットマスク

- IPアドレスの設定で「255…」と入力するやつ
- ネットワーク部とホスト部の切れ目を表すための値
  - 1bitずつ分けることで、サブネットの台数をある程度柔軟にできる
- 32bit（または128bit）の値を任意のbit数で区切るため、下記の書き方をする
  x.x.x.x/y ← yの部分がサブネットマスク（0 - 32）
  - CIDR (Classless InterDomain Routing)形式と呼ばれる

<img src="4.17.png" style="width: 400px;">
[図4.17]

## グローバルIP/プライベートIP

- IPアドレスはおおよそ43億通り
  - IoTがもてはやされる以前から全く足りていなかった
- 世界中で使えるグローバルIPと、クローズドな環境（社内ネットや家庭など）でのみ使えるプライベートIPが分けて定義された
  - 10.x.x.x、172.16.x.x、192.168.x.x

## 異なるサブネット同士の通信に必要なこと

- ゲートウェイ

  サブネットから外への出入り口 **サブネットで必ず1つだけ**

  - IPアドレスがサブネット内に存在しないときは、パケットをゲートウェイに飛ばす

- ルーティングテーブル
  サブネットを出て行くパケットを次にどこに転送したら良いかの情報を保持する表

ゲートウェイはルーティングテーブルを持っていて、ネットワーク間の橋渡しをしている。
そのためこれを行う端末は **ルーター** と呼ばれる。

## ネットワークとルーティングの概要

<img src="4.23.png" style="width: 400px;">
[図4.23]

## パケットの分割、再構築（削る予定）

- ネットワーク層の一つ上の層（データリンク層）で転送可能な最大サイズ（MTU）に収まるよう、パケットを分割する

<img src="4.24.png" style="width: 400px;">
[図4.24]

# ちょっと待って

各層がそれより下位の層のことを考えなくてもいいなら、
アプリケーション層でソフトウェアを作る上でも
TCP/IPのことなんて知らなくてもいいんじゃない？

## その通りです（それが理想）

しかし、作った後の保守やトラブル対応の原因分析などになると、そうも言ってられないことが多い。

- インターネットなどを経由する場合、パケットが大きく断片化することがある
  - 経路は自分で選べないため、途中で小さいMTUの経路を通過する可能性がある
    - MTUが小さいと
      TCPで分割されていたパケットがIPで更に分割されてしまう
      分割/再構築処理が過多になる
      パケットの中でヘッダの占める割合が大きくなる
      →結果的に狭帯域環境に追いやられる
  - 当初は想定していなかった通信障害が発生したり、システムが不安定になるなどのリスクが高まる
- 最近のOSは大きなMTUをとる経路を探索するアルゴリズムが実装されている
  最初は遅かった通信が、しばらくたつと速くなる挙動を示す

# データリンク層

＿人人人人人人人人人＿
＞　時間がたりない　＜
￣Y^Y^Y^Y^Y^Y^Y^Y￣

# おまけ

## DNS

# 参考文献等

1. マスタリング TCP/IP 入門編 第5版, 竹下隆史 他, オーム社

2. 基礎からわかる TCP/IP ネットワーク実験プログラミング 第2版, 村山公保, オーム社

# もっと知りたい人は…

- TCPのこと、全然話しきれていません。
- データリンク層（L2）のことも話していません。
- 他にもNAPT、ファイアウォール、VPN、無線技術、IPv6、ルーティングプロトコル、イントラ設計、広域イーサなど、奥が深いです。

- マスタリングシリーズは良書だと思っています。
- 自宅サーバーを構築すると自然とネットワークのことを勉強できます。
- 「ポートミラーリング機能付きL2スイッチ」と「Wireshark」でマニアックになろう！